#!/bin/sh

set e

if [ "${DEBUG}" = true ]; then
  set -x
fi

DEF_PORT=
DEF_VOLUME_HOME=/opt/docker
DEF_VERSION=1.8.2
DEF_NAME=gitea

DEF_GITEA_PROTOCOL=http
DEF_GITEA_DOMAIN=locahost

DEF_GITEA_SMTP_FROM=gitea@localhost
DEF_GITEA_SMTP_HOST=localhost
DEF_GITEA_SMTP_PORT=25
DEF_GITEA_SMTP_USER=
DEF_GITEA_SMTP_PASS=

DEF_GITEA_REGISTRATION_DISABLE=false
DEF_GITEA_RECAPTCHA_SECRET=
DEF_GITEA_RECAPTCHA_KEY=

DEF_GITEA_INSTALL_LOCK=false
DEF_GITEA_SECRET_KEY=
DEF_GITEA_JWT_SECRET=

DEF_GITEA_ROOT_EMAIL=root@localhost
DEF_GITEA_ROOT_PASSWORD=Git3aPa55

DEF_LINK_CONTAINERS=

PORT=${PORT:-$DEF_PORT}
VOLUME_HOME=${VOLUME_HOME:-$DEF_VOLUME_HOME}
VERSION=${VERSION:-$DEF_VERSION}
NAME=${NAME:-$DEF_NAME}

GITEA_PROTOCOL=${GITEA_PROTOCOL:-$DEF_GITEA_PROTOCOL}
GITEA_DOMAIN=${GITEA_DOMAIN:-$DEF_GITEA_DOMAIN}

GITEA_SMTP_HOST=${GITEA_SMTP_HOST:-$DEF_GITEA_SMTP_HOST}
GITEA_SMTP_PORT=${GITEA_SMTP_PORT:-$DEF_GITEA_SMTP_PORT}
GITEA_SMTP_FROM=${GITEA_SMTP_FROM:-$DEF_GITEA_SMTP_FROM}
GITEA_SMTP_USER=${GITEA_SMTP_USER:-$DEF_GITEA_SMTP_USER}
GITEA_SMTP_PASS=${GITEA_SMTP_PASS:-$DEF_GITEA_SMTP_PASS}

GITEA_REGISTRATION_DISABLE=${GITEA_REGISTRATION_DISABLE:-$DEF_GITEA_REGISTRATION_DISABLE}
GITEA_RECAPTCHA_SECRET=${GITEA_RECAPTCHA_SECRET:-$DEF_GITEA_RECAPTCHA_SECRET}
GITEA_RECAPTCHA_KEY=${GITEA_RECAPTCHA_KEY:-$DEF_GITEA_RECAPTCHA_KEY}

GITEA_INSTALL_LOCK=${GITEA_INSTALL_LOCK:-$DEF_GITEA_INSTALL_LOCK}
GITEA_SECRET_KEY=${GITEA_SECRET_KEY:-$DEF_GITEA_SECRET_KEY}
GITEA_JWT_SECRET=${GITEA_JWT_SECRET:-$DEF_GITEA_JWT_SECRET}

GITEA_ROOT_EMAIL=${GITEA_ROOT_EMAIL:-$DEF_GITEA_ROOT_EMAIL}
GITEA_ROOT_PASSWORD=${GITEA_ROOT_PASSWORD:-$DEF_GITEA_ROOT_PASSWORD}

LINK_CONTAINERS=${LINK_CONTAINERS:-$DEF_LINK_CONTAINERS}

if [ -z ${LINK_CONTAINERS} ]; then
  LINK_LINE=""
else 
  OIFS=$IFS
  IFS=','
  for LINK in $LINK_CONTAINERS
  do
     LINK_LINE="${LINK_LINE} --link ${LINK} "
  done
  IFS=$OIFS
fi

if [ -z ${PORT} ]; then
  PORT_LINE=""
else 
  PORT_LINE="-p ${PORT}:3000 "
fi

/bin/cat <<-EOF
[Unit]
Description=Gitea Server

After=docker.service

[Service]
TimeoutStartSec=0

ExecStartPre=-/bin/mkdir -p ${VOLUME_HOME}/${NAME}/etc
ExecStartPre=-/bin/mkdir -p ${VOLUME_HOME}/${NAME}/lib
ExecStartPre=-/bin/mkdir -p ${VOLUME_HOME}/${NAME}/log
ExecStartPre=-/usr/bin/docker stop ${NAME}
ExecStartPre=-/usr/bin/docker rm ${NAME}
ExecStartPre=-/usr/bin/docker pull madharjan/docker-gitea:${VERSION}

ExecStart=/usr/bin/docker run \\
  ${LINK_LINE}-e GITEA_PROTOCOL=${GITEA_PROTOCOL} \\
  -e GITEA_DOMAIN=${GITEA_DOMAIN} \\
  -e GITEA_SMTP_HOST=${GITEA_SMTP_HOST} \\
  -e GITEA_SMTP_PORT=${GITEA_SMTP_PORT} \\
  -e GITEA_REGISTRATION_DISABLE=${GITEA_REGISTRATION_DISABLE} \\
  -e GITEA_INSTALL_LOCK=${GITEA_INSTALL_LOCK} \\
  -e GITEA_SECRET_KEY=${GITEA_SECRET_KEY} \\
  -e GITEA_JWT_SECRET=${GITEA_JWT_SECRET} \\
  -e GITEA_ROOT_EMAIL=${GITEA_ROOT_EMAIL} \\
  -e GITEA_ROOT_PASSWORD=${GITEA_ROOT_PASSWORD} \\
  ${PORT_LINE}-v ${VOLUME_HOME}/${NAME}/etc:/etc/gitea/etc \\
  -v ${VOLUME_HOME}/${NAME}/lib:/var/lib/gitea \\
  -v ${VOLUME_HOME}/${NAME}/log:/var/log/gitea \\
  --name ${NAME} \\
  madharjan/docker-gitea:${VERSION}

ExecStop=/usr/bin/docker stop -t 2 ${NAME}

[Install]
WantedBy=multi-user.target
EOF